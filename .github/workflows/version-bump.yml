name: Version Bump

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  bump:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine bump
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const commits = context.payload.commits || [];
            let bump = null;
            for (const commit of commits) {
              const message = commit.message || "";
              if (/^major:/i.test(message)) {
                bump = "major";
                break;
              }
              if (!bump && /^feature:/i.test(message)) {
                bump = "minor";
              }
              if (!bump && /^patch:/i.test(message)) {
                bump = "patch";
              }
            }
            core.setOutput("type", bump ?? "");

      - name: Stop if no bump
        if: steps.bump.outputs.type == ''
        run: echo "No version bump required."

      - name: Configure git
        if: steps.bump.outputs.type != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        if: steps.bump.outputs.type != ''
        run: |
          npm version ${{ steps.bump.outputs.type }} -m "chore(release): v%s"

      - name: Push changes
        if: steps.bump.outputs.type != ''
        run: |
          git push origin main --follow-tags
